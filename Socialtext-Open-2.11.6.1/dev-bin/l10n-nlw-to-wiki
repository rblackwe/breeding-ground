#!/usr/bin/perl
#
# Copyright (C) 2004-2006 by Socialtext, Inc.
#
use strict;
use warnings;
use FindBin qw/$Bin/;
use lib "$Bin/../lib";
use Socialtext::Wikil10n qw/load_existing_l10ns make_rester/;
use Socialtext::System qw/shell_run/;
use Locale::PO;

my @files = (
    'share/template/view/homepage',
    'share/javascript/revisions.js',
    'lib/Socialtext/CLI.pm',
);

my $en_file = "nlw-en.po";
shell_run("xgettext.pl -o $en_file @files");
die unless -e $en_file;
po_to_wiki($en_file);
exit;


sub po_to_wiki {
    my $pos = Locale::PO->load_file_asarray(shift);
    my $r = make_rester();

    print "Fetching pages tagged l10n...\n";
    my @locale_pages = $r->get_taggedpages('l10n');
    for my $title (@locale_pages) {
        print "Updating localizations for - $title\n";
        my $existing_pos = load_existing_l10ns($r, $title);

        my $new_page = <<EOT;
This page is autogenerated, only edit the 'translation' column.

| *Key* | *Translation* | *Reference* | *Other* |
EOT
        for my $po (@$pos) {
            my $msgid = $po->msgid or die "No msgid?";
            $msgid =~ s/^"(.*)"$/$1/;
            next unless $msgid;
            my $msgstr = $existing_pos->{$msgid}{msgstr} || '';
            $new_page .= "| "
                . join( ' | ', 
                    $msgid,
                    $msgstr,
                    $po->reference || '',
                    $po->automatic || '' )
                . " |\n";
        }
        $r->put_page($title, $new_page);
    }
}

